{% extends "base.html" %}

{% block title %}Game Night Tracker - Add New Game{% endblock %}

{% block head %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/games.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/admin.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/scores.css') }}">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
{% endblock %}

{% block content %}
<div class="page-header">
    <div class="page-header-content">
        <h1>Add New Game</h1>
        <p class="page-subtitle">Create a new game with scoring settings</p>
    </div>
    <a href="{{ url_for('main.games') }}" class="btn btn-secondary">
        <i class="fas fa-arrow-left"></i> Back to Games
    </a>
</div>

<div class="card form-card">
    <form method="POST" action="{{ url_for('admin.add_game') }}">
        {{ form.hidden_tag() }}

        <div class="form-section">
            <h2>Basic Information</h2>

            <div class="form-row">
                <div class="form-group">
                    {{ form.name.label }}
                    {{ form.name(class="form-control", placeholder="Enter game name") }}
                    {% if form.name.errors %}
                        <div class="form-error">
                            {% for error in form.name.errors %}
                                <span>{{ error }}</span>
                            {% endfor %}
                        </div>
                    {% endif %}
                </div>

                <div class="form-group">
                    {{ form.type.label }}
                    {{ form.type(class="form-control", id="game-type-select", onchange="toggleCustomType()") }}
                    {% if form.type.errors %}
                        <div class="form-error">
                            {% for error in form.type.errors %}
                                <span>{{ error }}</span>
                            {% endfor %}
                        </div>
                    {% endif %}
                </div>
            </div>

            <div class="form-group" id="custom-type-group" style="display: none;">
                {{ form.custom_type.label }}
                {{ form.custom_type(class="form-control", placeholder="e.g., Board Game, Card Game, Puzzle") }}
                <p class="help-text">Enter your custom game type name</p>
            </div>

            <div class="form-group">
                {{ form.sequence_number.label }}
                <div class="sequence-input-wrapper">
                    {{ form.sequence_number(class="form-control", placeholder=next_sequence) }}
                    <div class="sequence-helper">
                        <span class="sequence-badge">Recommended: {{ next_sequence }}</span>
                    </div>
                </div>
                {% if form.sequence_number.errors %}
                    <div class="form-error">
                        {% for error in form.sequence_number.errors %}
                            <span>{{ error }}</span>
                        {% endfor %}
                    </div>
                {% endif %}
                <p class="help-text">üìù This number controls the game order. Use {{ next_sequence }} to add at the end, or use any number to insert between existing games.</p>

                {% if existing_games %}
                <div class="game-order-preview">
                    <strong>Current Game Order:</strong>
                    <ol class="game-order-list">
                        {% for existing_game in existing_games %}
                        <li>
                            <span class="game-seq">{{ existing_game.sequence_number }}.</span>
                            <span class="game-name-preview">{{ existing_game.name }}</span>
                            <span class="game-status-mini">{{ '‚úì' if existing_game.isCompleted else '‚óã' }}</span>
                        </li>
                        {% endfor %}
                    </ol>
                </div>
                {% endif %}
            </div>
        </div>

        <div class="form-section">
            <h2>Game Mode</h2>
            <p class="help-text">Choose between regular scoring or tournament bracket</p>

            <div class="game-mode-toggle">
                <div class="checkbox-group">
                    <input type="checkbox" id="create_as_tournament" name="create_as_tournament" class="form-check" onchange="toggleGameMode()">
                    <label for="create_as_tournament">üèÜ Create as Tournament (elimination bracket)</label>
                </div>
            </div>
        </div>

        <div class="form-section" id="scoring-section">
            <h2>Scoring Settings</h2>

            <div class="form-row">
                <div class="form-group">
                    {{ form.point_scheme.label }}
                    {{ form.point_scheme(class="form-control") }}
                    {% if form.point_scheme.errors %}
                        <div class="form-error">
                            {% for error in form.point_scheme.errors %}
                                <span>{{ error }}</span>
                            {% endfor %}
                        </div>
                    {% endif %}
                    <p class="help-text">Points awarded between each place</p>
                </div>

                <div class="form-group">
                    {{ form.metric_type.label }}
                    {{ form.metric_type(class="form-control") }}
                    {% if form.metric_type.errors %}
                        <div class="form-error">
                            {% for error in form.metric_type.errors %}
                                <span>{{ error }}</span>
                            {% endfor %}
                        </div>
                    {% endif %}
                    <p class="help-text">How teams will be scored</p>
                </div>
            </div>

            <div class="form-group">
                <label>Scoring Direction</label>
                <div class="scoring-direction-tiles">
                    <div class="scoring-tile" data-value="higher_better" data-tooltip="Example: Most points wins">
                        <div class="tile-icon">üèÜ</div>
                        <div class="tile-label">Higher Wins</div>
                    </div>
                    <div class="scoring-tile" data-value="lower_better" data-tooltip="Example: Fastest time wins">
                        <div class="tile-icon">‚è±</div>
                        <div class="tile-label">Lower Wins</div>
                    </div>
                </div>
                {{ form.scoring_direction(id="scoring_direction", style="display: none;") }}
                {% if form.scoring_direction.errors %}
                    <div class="form-error">
                        {% for error in form.scoring_direction.errors %}
                            <span>{{ error }}</span>
                        {% endfor %}
                    </div>
                {% endif %}
            </div>

            <div class="form-group">
                <div class="checkbox-group">
                    {{ form.public_input(class="form-check") }}
                    {{ form.public_input.label }}
                </div>
                <p class="help-text">Allow participants to enter their own scores</p>
            </div>
        </div>

        <div class="form-section" id="penalties-section">
            <h2>Penalties</h2>
            <p class="help-text">Define penalties such as "False start (+5)" or "Missed target (+10)". Units are automatically based on the scoring method (time = seconds, otherwise = points).</p>

            <div id="penalties-container">
                <!-- Penalties will be added here dynamically -->
            </div>

            <button type="button" class="btn btn-secondary" id="add-penalty-btn">
                <i class="fas fa-plus"></i> Add Penalty
            </button>
        </div>

        <div class="form-actions">
            <button type="submit" class="btn btn-primary">
                <i class="fas fa-save"></i> Create Game
            </button>
            <a href="{{ url_for('main.games') }}" class="btn btn-secondary">Cancel</a>
        </div>
    </form>
</div>
{% endblock %}

{% block scripts %}
<script>
// Pass team count to JavaScript
window.teamCount = {{ team_count }};

// Toggle custom type input
function toggleCustomType() {
    const typeSelect = document.getElementById('game-type-select');
    const customTypeGroup = document.getElementById('custom-type-group');

    if (typeSelect.value === 'custom') {
        customTypeGroup.style.display = 'block';
    } else {
        customTypeGroup.style.display = 'none';
    }
}

// Toggle between tournament mode and regular scoring
function toggleGameMode() {
    const tournamentCheckbox = document.getElementById('create_as_tournament');
    const scoringSection = document.getElementById('scoring-section');
    const penaltiesSection = document.getElementById('penalties-section');

    if (tournamentCheckbox.checked) {
        scoringSection.style.display = 'none';
        penaltiesSection.style.display = 'none';
    } else {
        scoringSection.style.display = 'block';
        penaltiesSection.style.display = 'block';
    }
}

// Check on page load
document.addEventListener('DOMContentLoaded', function() {
    toggleCustomType();
    toggleGameMode();
});
</script>
<script src="{{ url_for('static', filename='js/games.js') }}"></script>

<style>
.game-mode-toggle {
    padding: 1rem;
    background: rgba(139, 92, 246, 0.05);
    border-radius: var(--radius-md);
    border: 1px solid rgba(139, 92, 246, 0.2);
}

.game-mode-toggle .checkbox-group {
    margin: 0;
}

.game-mode-toggle label {
    font-weight: 600;
    color: var(--text-primary);
    cursor: pointer;
}

.game-mode-toggle input:checked + label {
    color: #8b5cf6;
}
</style>
{% endblock %}
